name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-projects:
    name: "test-projects (project: ${{ matrix.project }})"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - TelecomAI-Customer-Intelligence
          - CarVision-Market-Intelligence
          - BankChurn-Predictor
          - GoldRecovery-Process-Optimizer
          - Chicago-Mobility-Analytics
          - Gaming-Market-Intelligence
          - OilWell-Location-Optimizer
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Set PYTHONPATH
        run: |
          REPO_ROOT="${GITHUB_WORKSPACE:-$(pwd)}"
          echo "PYTHONPATH=$PYTHONPATH:${REPO_ROOT}:${REPO_ROOT}/${{ matrix.project }}" >> $GITHUB_ENV
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles(format('{0}/requirements.txt', matrix.project)) }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ "${{ matrix.project }}" = "TelecomAI-Customer-Intelligence" ] || [ "${{ matrix.project }}" = "BankChurn-Predictor" ] || [ "${{ matrix.project }}" = "OilWell-Location-Optimizer" ]; then
            pip install -r requirements.in
          else
            pip install -r requirements.txt
          fi
        working-directory: ${{ matrix.project }}
      - name: Run tests
        run: pytest --cov=. --cov-report=term-missing
        working-directory: ${{ matrix.project }}
      - name: Type-check
        run: |
          python -m pip install mypy
          if [ "${{ matrix.project }}" = "TelecomAI-Customer-Intelligence" ]; then
            mypy main.py app monitoring scripts tests
          elif [ "${{ matrix.project }}" = "GoldRecovery-Process-Optimizer" ]; then
            mypy main.py app monitoring scripts tests
          elif [ "${{ matrix.project }}" = "Gaming-Market-Intelligence" ]; then
            mypy main.py app monitoring scripts tests
          elif [ "${{ matrix.project }}" = "OilWell-Location-Optimizer" ]; then
            mypy main.py app monitoring scripts tests
          else
            mypy .
          fi
        working-directory: ${{ matrix.project }}
      - name: Lint
        run: |
          python -m pip install flake8
          flake8 .
        working-directory: ${{ matrix.project }}
      - name: Smoke train (BankChurn only)
        if: matrix.project == 'BankChurn-Predictor'
        env:
          SMOKE: "1"
        run: |
          python main.py --mode train --config configs/config.yaml --seed 42 --input data/raw/Churn.csv
        working-directory: ${{ matrix.project }}
