name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-projects:
    name: "test-projects (project: ${{ matrix.project }})"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - TelecomAI-Customer-Intelligence
          - CarVision-Market-Intelligence
          - BankChurn-Predictor
          - GoldRecovery-Process-Optimizer
          - Chicago-Mobility-Analytics
          - Gaming-Market-Intelligence
          - OilWell-Location-Optimizer
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Set PYTHONPATH
        run: |
          REPO_ROOT="${GITHUB_WORKSPACE:-$(pwd)}"
          echo "PYTHONPATH=$PYTHONPATH:${REPO_ROOT}:${REPO_ROOT}/${{ matrix.project }}" >> $GITHUB_ENV
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles(format('{0}/requirements.txt', matrix.project)) }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ "${{ matrix.project }}" = "TelecomAI-Customer-Intelligence" ] || [ "${{ matrix.project }}" = "BankChurn-Predictor" ] || [ "${{ matrix.project }}" = "OilWell-Location-Optimizer" ]; then
            pip install -r requirements.in
          else
            pip install -r requirements.txt
          fi
        working-directory: ${{ matrix.project }}
      - name: Run tests
        run: |
          COV_FAIL_UNDER=70

          if [ "${{ matrix.project }}" = "BankChurn-Predictor" ]; then
            COV_FAIL_UNDER=40
          elif [ "${{ matrix.project }}" = "GoldRecovery-Process-Optimizer" ]; then
            COV_FAIL_UNDER=20
          elif [ "${{ matrix.project }}" = "Chicago-Mobility-Analytics" ]; then
            COV_FAIL_UNDER=35
          elif [ "${{ matrix.project }}" = "Gaming-Market-Intelligence" ]; then
            COV_FAIL_UNDER=30
          elif [ "${{ matrix.project }}" = "OilWell-Location-Optimizer" ]; then
            COV_FAIL_UNDER=40
          fi

          pytest --cov=. --cov-report=term-missing --cov-report=xml --cov-fail-under=$COV_FAIL_UNDER -m "not slow" -v
        working-directory: ${{ matrix.project }}
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ${{ matrix.project }}/coverage.xml
          flags: ${{ matrix.project }}
          name: ${{ matrix.project }}
      - name: Type-check
        run: |
          python -m pip install mypy
          if [ "${{ matrix.project }}" = "TelecomAI-Customer-Intelligence" ]; then
            mypy main.py app monitoring scripts tests
          elif [ "${{ matrix.project }}" = "GoldRecovery-Process-Optimizer" ]; then
            mypy main.py app monitoring scripts tests
          elif [ "${{ matrix.project }}" = "Gaming-Market-Intelligence" ]; then
            mypy main.py app monitoring scripts tests
          elif [ "${{ matrix.project }}" = "OilWell-Location-Optimizer" ]; then
            mypy main.py app monitoring scripts tests
          else
            mypy .
          fi
        working-directory: ${{ matrix.project }}
      - name: Lint
        run: |
          python -m pip install flake8
          flake8 .
        working-directory: ${{ matrix.project }}
      - name: Smoke tests (E2E)
        if: matrix.project == 'BankChurn-Predictor' || matrix.project == 'TelecomAI-Customer-Intelligence'
        env:
          SMOKE: "1"
          SEED: 42
        run: |
          if [ "${{ matrix.project }}" = "BankChurn-Predictor" ]; then
            # Test new CLI if available, fallback to main.py
            if [ -d "src/bankchurn" ]; then
              python -m src.bankchurn.cli train --config configs/config.yaml --input data/raw/Churn.csv --no-cv || python main.py --mode train --config configs/config.yaml --seed 42 --input data/raw/Churn.csv
            else
              python main.py --mode train --config configs/config.yaml --seed 42 --input data/raw/Churn.csv
            fi
          elif [ "${{ matrix.project }}" = "TelecomAI-Customer-Intelligence" ]; then
            python main.py --mode train --config configs/config.yaml --seed 42
          fi
        working-directory: ${{ matrix.project }}
  
  docker-builds:
    name: "Docker: ${{ matrix.project }}"
    runs-on: ubuntu-latest
    needs: test-projects
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        project:
          - BankChurn-Predictor
          - TelecomAI-Customer-Intelligence
          - CarVision-Market-Intelligence
          - Chicago-Mobility-Analytics
          - GoldRecovery-Process-Optimizer
          - Gaming-Market-Intelligence
          - OilWell-Location-Optimizer
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker image
        working-directory: ${{ matrix.project }}
        run: |
          # Convert project name to lowercase for Docker tag
          IMAGE_NAME=$(echo "${{ matrix.project }}" | tr '[:upper:]' '[:lower:]')
          docker build -t ${IMAGE_NAME}:ci-test .
      - name: Test Docker healthcheck
        run: |
          # Convert project name to lowercase for Docker tag
          IMAGE_NAME=$(echo "${{ matrix.project }}" | tr '[:upper:]' '[:lower:]')
          docker run -d --name test-container -p 8000:8000 ${IMAGE_NAME}:ci-test || true
          sleep 10
          docker ps -a
          docker logs test-container || true
  
  integration-report:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [test-projects, docker-builds]
    if: always()
    steps:
      - name: Report CI Status
        run: |
          echo "âœ… Portfolio CI/CD Complete"
          echo "Tests: ${{ needs.test-projects.result }}"
          echo "Docker Builds: ${{ needs.docker-builds.result }}"

  # slow-tests:
  #   name: "slow-tests (project: ${{ matrix.project }})"
  #   runs-on: ubuntu-latest
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       project:
  #         - TelecomAI-Customer-Intelligence
  #         - CarVision-Market-Intelligence
  #         - BankChurn-Predictor
  #         - GoldRecovery-Process-Optimizer
  #         - Chicago-Mobility-Analytics
  #         - Gaming-Market-Intelligence
  #         - OilWell-Location-Optimizer
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     - name: Setup Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.10'
  #     - name: Set PYTHONPATH
  #       run: |
  #         REPO_ROOT="${GITHUB_WORKSPACE:-$(pwd)}"
  #         echo "PYTHONPATH=$PYTHONPATH:${REPO_ROOT}:${REPO_ROOT}/${{ matrix.project }}" >> $GITHUB_ENV
  #     - name: Cache pip
  #       uses: actions/cache@v4
  #       with:
  #         path: ~/.cache/pip
  #         key: ${{ runner.os }}-pip-${{ hashFiles(format('{0}/requirements.txt', matrix.project)) }}
  #         restore-keys: |
  #           ${{ runner.os }}-pip-
  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         if [ "${{ matrix.project }}" = "TelecomAI-Customer-Intelligence" ] || [ "${{ matrix.project }}" = "BankChurn-Predictor" ] || [ "${{ matrix.project }}" = "OilWell-Location-Optimizer" ]; then
  #           pip install -r requirements.in
  #         else
  #           pip install -r requirements.txt
  #         fi
  #       working-directory: ${{ matrix.project }}
  #     - name: Run slow tests
  #       run: pytest -m slow --cov=. --cov-report=term-missing
  #       working-directory: ${{ matrix.project }}
